#!/usr/bin/env ruby

require 'mongo_oplog_backup'
require 'slop'

opts = Slop.parse(help: true, strict: true) do
  banner 'Usage: mongo-oplog-backup [options]'

  command 'backup' do
  banner 'Usage: mongo-oplog-backup backup [options]'
    on :v, :verbose, 'Enable verbose mode'
    on :d, :dir, "Directory to store backup files. Defaults to 'backup'.", argument: :required
    on :full, 'Force full backup'
    on :oplog, 'Force oplog backup'

    run do |opts, args|
      dir = opts[:dir] || 'backup'
      mode = :auto
      if opts.full?
        mode = :full
      elsif opts.oplog?
        mode = :oplog
      end
      config = MongoOplogBackup::Config.new(dir: dir)
      backup = MongoOplogBackup::Backup.new(config)
      backup.perform(mode)
    end
  end

  command 'merge' do
  banner 'Usage: mongo-oplog-backup merge [options]'
    on :v, :verbose, 'Enable verbose mode'
    on :d, :dir, "Directory containing the backup to restore. Must contain a 'dump' folder.", argument: :required

    run do |opts, args|
      dir = opts[:dir]
      raise ArgumentError, 'dir must be specified' unless dir
      raise ArgumentError, 'dir must contain a dump subfolder' unless File.directory?(File.join(dir, 'dump'))

      MongoOplogBackup::Oplog.merge_backup(dir)
      puts
      puts "Restore the backup with: "
      puts "mongorestore [--drop] --oplogReplay #{File.join(dir, 'dump')}"
    end
  end
end
